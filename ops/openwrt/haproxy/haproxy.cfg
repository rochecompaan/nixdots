# HAProxy configuration for OpenWrt router
# Purpose: Load-balance homelab ingress (80/443) to Traefik NodePorts
#          and k3s API (6443) across cluster nodes.
# Notes:
# - Update the IPs below to match your nodes.
# - These server names are labels only; IPs are used for routing.

# Global parameters
global
    # Log events to a remote syslog server at given address using the
    # specified facility and verbosity level. Multiple log options
    # are allowed.
    #log 10.0.0.1 daemon info

    # Specify the maximum number of allowed connections.
    # OpenWrt devices have limited resources; 1024 is a balanced default.
    maxconn 1024

    # Raise the ulimit for open file descriptors so maxsock >= maxconn*2.
    # Set comfortably above the computed requirement to prevent startup aborts.
    ulimit-n 8192

    # Drop privileges (setuid, setgid), default is "root" on OpenWrt.
    uid 0
    gid 0

    # Perform chroot into the specified directory.
    #chroot /var/run/haproxy/

    # Daemonize on startup
    daemon

    nosplice
    # Enable debugging
    #debug

    # Spawn given number of processes and distribute load among them,
    # used for multi-core environments or to circumvent per-process
    # limits like number of open file descriptors. Default is 1.
    #nbproc 2

# Default parameters
defaults
    # Default timeouts
    timeout connect 5s
    timeout client 300s
    timeout server 600s


# HTTP (80) → Traefik NodePort 30080 (HTTP mode)
listen http_traefik
    bind :80
    mode http
    balance roundrobin
    option forwardfor
    option httpchk GET /
    server dauwalter 192.168.1.100:30080 check
    server kipsang   192.168.1.101:30080 check
    server fordyce   192.168.1.102:30080 check
    server walmsley  192.168.1.103:30080 check

# HTTPS (443) → Traefik NodePort 30443 (TCP passthrough)
listen https_traefik
    bind :443
    mode tcp
    balance roundrobin
    server dauwalter 192.168.1.100:30443 check
    server kipsang   192.168.1.101:30443 check
    server fordyce   192.168.1.102:30443 check
    server walmsley  192.168.1.103:30443 check

# Kubernetes API (6443) → Node 6443 (TCP)
# TODO: remove once OpenZiti is up and running
listen k3s_api
    bind 192.168.1.1:6443
    mode tcp
    balance roundrobin
    server dauwalter 192.168.1.100:6443 check
    server kipsang   192.168.1.101:6443 check
    server fordyce   192.168.1.102:6443 check
    server walmsley  192.168.1.103:6443 check

# Standalone stats UI (HTTP mode) — avoids warnings on TCP proxies
listen haproxy_stats
    bind 192.168.1.1:8404
    mode http
    stats enable
    stats refresh 10s
    stats uri /stats
    stats realm HA_Stats
    # Change these credentials as desired
    stats auth admin:admin
